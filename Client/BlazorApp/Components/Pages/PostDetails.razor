@page "/posts/{Id:int}"
@using ApiContracts
@using BlazorApp.Services
@inject HttpClient Http
@inject NavigationManager Navigation

<h1>Post Details</h1> 
<span><button class="btn btn-secondary" @onclick="GoBack">Back</button></span>

@if (isLoading)
{
    <p>Loading post...</p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else if (post != null)
{
    <div class="card mt-3">
        <div class="card-body">
            <h3>
                @post.Title
                <small class="text-muted">- By @(post.Author?.UserName ?? $"User #{post.UserId}")</small>
            </h3>
            <p>@post.Body</p>
        </div>
    </div>

    <h4 class="mt-4">Comments @(@comments?.Count ?? 0)</h4>

    @if (comments != null && comments.Any())
    {
        @foreach (var c in comments)
        {
            <div class="card mt-2">
                <div class="card-body">
                    <p>@c.Body</p>
                    <small class="text-muted">By @(c.User?.UserName ?? $"User #{c.UserId}")</small>
                </div>
            </div>
        }
    }
    else
    {
        <p>No comments yet.</p>
    }

    <div class="card mt-4 p-3">
        <h5>Add a Comment</h5>
        <div class="mb-2">
            <label for="username">User Name</label>
            <InputText id="username" class="form-control" @bind-Value="newCommentUserName" />
        </div>
        <div class="mb-2">
            <label for="body">Comment</label>
            <InputTextArea id="body" class="form-control" @bind-Value="newCommentBody" />
        </div>
        <button class="btn btn-primary" @onclick="AddComment" disabled="@isAddingComment">
            @(isAddingComment ? "Adding..." : "Add Comment")
        </button>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private PostDto? post;
    private List<CommentDto>? comments;
    private bool isLoading;
    private string? errorMessage;

    private string newCommentUserName = string.Empty;
    private string newCommentBody = string.Empty;
    private bool isAddingComment;

    private IPostService postService => new HttpPostService(Http);
    private ICommentService commentService => new HttpCommentService(Http);

    protected override async Task OnInitializedAsync()
    {
        await LoadPost();
    }

    private async Task LoadPost()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            post = await postService.GetPostAsync(Id);
            comments = (await commentService.GetAllComments(Id, null, null)).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to load post: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/posts");
    }

    private async Task AddComment()
    {
        if (string.IsNullOrWhiteSpace(newCommentUserName) || string.IsNullOrWhiteSpace(newCommentBody))
        {
            errorMessage = "Both user name and comment body are required.";
            return;
        }

        isAddingComment = true;
        errorMessage = null;

        try
        {
            // Initialize the user service
            var userService = new HttpUserService(Http);

            // Fetch users filtered by username
            var users = await userService.GetAllAsync(newCommentUserName);

            // Get the first matching user
            var user = users.FirstOrDefault();
            if (user == null)
            {
                errorMessage = $"User '{newCommentUserName}' not found.";
                return;
            }

            // Create the comment DTO
            var createComment = new CreateCommentDto
            {
                PostId = Id,
                UserId = user.Id,
                Body = newCommentBody
            };

            // Add comment via the comment service
            await commentService.AddComment(createComment);

            // Reload all comments
            comments = (await commentService.GetAllComments(Id)).ToList();

            // Clear input fields
            newCommentUserName = string.Empty;
            newCommentBody = string.Empty;
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to add comment: " + ex.Message;
        }
        finally
        {
            isAddingComment = false;
        }
    }
}