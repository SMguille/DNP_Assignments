@page "/posts/create"
@attribute [Authorize]

@using ApiContracts
@using BlazorApp.Services
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Create Post</PageTitle>

<h1>Create New Post</h1>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

<div class="card mt-3 p-3">
    <div class="mb-2">
        <label for="title">Title</label>
        <InputText id="title" class="form-control" @bind-Value="newPostTitle" />
    </div>

    <div class="mb-2">
        <label for="body">Body</label>
        <InputTextArea id="body" class="form-control" @bind-Value="newPostBody" />
    </div>

    <div class="mb-2">
        <label for="subforum">SubForum ID</label>
        <InputNumber id="subforum" class="form-control" @bind-Value="newPostSubForumId" />
    </div>

    <button class="btn btn-primary" @onclick="SubmitPost" disabled="@isCreatingPost">
        @(isCreatingPost ? "Creating..." : "Create Post")
    </button>
    <button class="btn btn-secondary ms-2" @onclick="GoBack">Cancel</button>
</div>

@code {
    [CascadingParameter] public Task<AuthenticationState> AuthState { get; set; } = default!;

    private string newPostTitle = string.Empty;
    private string newPostBody = string.Empty;
    private int newPostSubForumId = 0;

    private bool isCreatingPost;
    private string? errorMessage;

    private IPostService postService => new HttpPostService(Http);

    protected override void OnInitialized()
    {
        // Optionally initialize defaults here
    }

    private async Task SubmitPost()
    {
        if (string.IsNullOrWhiteSpace(newPostTitle) || string.IsNullOrWhiteSpace(newPostBody))
        {
            errorMessage = "Title and body are required.";
            return;
        }

        // get authenticated user id from claims
        var auth = await AuthState;
        var user = auth.User;
        if (!(user.Identity?.IsAuthenticated ?? false))
        {
            errorMessage = "You must be authenticated to create a post.";
            return;
        }

        var idClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? user.FindFirst("sub")?.Value;
        if (!int.TryParse(idClaim, out var userId))
        {
            errorMessage = "Unable to determine authenticated user id from claims.";
            return;
        }

        isCreatingPost = true;
        errorMessage = null;

        try
        {
            // optional: validate user exists via users API
            var userService = new HttpUserService(Http);
            var existing = await userService.GetUSer(userId);
            if (existing == null)
            {
                errorMessage = $"Authenticated user (id={userId}) not found.";
                return;
            }

            var createPost = new CreatePostDto
            {
                Title = newPostTitle,
                Body = newPostBody,
                UserId = userId,
                SubForumId = newPostSubForumId
            };

            await postService.AddPostAsync(createPost);

            Navigation.NavigateTo("/posts");
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to create post: " + ex.Message;
        }
        finally
        {
            isCreatingPost = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/posts");
    }
}
